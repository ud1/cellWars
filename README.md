# Cell Wars

Мир представляет собой торус. Точнее квадрат размером `W*W`, но края квадрата склеены, и тем самым топологически выходит торус, 
таким образом мир одновременно конечен, и в то же время не имеет явных границ. 
Координаты всех тел в игре вещественные, координаты `x` и `y` от `0` до `W`.

Все тела в мире являются кругами, они все имеют одинаковый радиус равный `0.5` и одинаковую массу равную `1`.
В дальнейшем они будут называться частицами. Число частиц в мире постоянно. Столкновение частиц абсолютно упругое, 
т.к. масса частиц одинаковая, то столкновения происходят как у бильярдных шаров, частицы просто обмениваются скоростями в системе центра масс.

Так как масса частиц равна `1`, то далее понятия `force` и `acceleration`, а также `скорость` и `импульс` можно считать эквивалентными.

Частицы внутри тика двигаются по прямым линиям, силы команд `applyForce` и `thrust` действуют только в начале тика,
они меняют один раз скорость частиц, и дальше внутри тика расчеты ведутся с новыми скоростями.

Один тик, `tick`, равен `16` миллисекунд.

## Эссенция
Каждая частица в игре может либо быть нейтральной, либо принадлежать одному из игроков.
Чтобы частица принадлежала игроку, у нее должно быть некое количество эссенции игрока.
Если частица принадлежит одному из игроков, у нее есть тип, и все свойства частицы определяются этим типом и количеством эссенции в ней.
Все частицы игрока могут передавать эссенцию другим частицам, и могут тем самым превращать нейтральные частицы в частицу принадлежащую игроку с нужным типом.

Частицы с типом `Accumulator` могут хранить и передавать повышенное число эссенции.
Частицы `Devourer` могут поглощать эссенцию других частиц.
Частицы с типом `Regenerator` и частица `Soul` регенерируют свою эссенцию.
Все частицы кроме `Soul` каждый тик теряют эссенцию, нужно за этим следить и подпитывать их, иначе они могут превратиться
в нейтральные. А так же многие свойства частиц зависят от уровня эссенции, чем ее меньше, тем они слабее.

При передаче эссенции от одной частицы другой, нужно указывать тип частицы, в которую мы хотим ее превратить.
Если частица, которой мы передаем эссенцию была нейтральной, то она обретает этот тип.
Если же она уже была этого типа и принадлежит нашему игроку, то величина её эссенции увеличивается.
В противном случае величина её эссенции уменьшается, т.е. фактически эссенция, что была в частице
взаимно уничтожается с эссенцией, которую мы ей передаем.

Эссенция может теряться при сильных изменениях в скорости частиц, например при воздействии взрыва или при столкновениях
на большой скорости. Это не касается частиц с типом `Explosive`, они не получают "урон", но могут самостоятельно детонировать.
Взорвавшееся частица `Explosive` полностью теряет свою эссенцию.

## Взаимодействие частиц
Частицы обладают близкодействием, т.е. могут напрямую взаимодействовать с другими частицами, если расстояние между центрами меньше `3.5` радиусов.
Каждая частица может притянуть или оттолкнуть другую частицу, если она находится близко, т.е. по факту скорость частиц может взаимно измениться
на определенную величину. В целом, в мире в большинстве случаев выполняется закон сохранения импульса,
два исключения из правила это при использовании команды `Thrust` у частицы с типом `Mover`, а так же при взрывах.
Из-за этого, при взрывах близкие частицы превращаются в нейтральные, т.к. их уровень эссенции падает до нуля.

## Типы частиц
Бывают следующие типы частиц:
 - `Neutral` - нейтральная частица - частица, что не содержит эссенции. Не управляется игроком. 
 - `Mover` - движитель, может самостоятельно менять свою скорость. Максимальная величина ускорения зависит от уровня эссенции.
 - `Accumulator` - может хранить и передавать повышенное количество эссенции. Можно формировать цепочки из них, чтобы быстро переносить эссенцию по всей длине цепочки.
 - `Shell` - меньше других частиц подвержен урону. А так же имеет в несколько раз большую силу воздействия на другие частицы. Сила зависит от величины хранящиеся в ней эссенции.
 - `Explosive` - взрывчатка, ее можно взорвать, в таком случае все тела находящиеся в радиусе взрыва получают импульс, а из-за повышенного ускорения частицы получают урон, т.е. велина хранимой эссенции уменьшается.
Сама же частица взрывчатки превращается в нейтральную частицу. Сила взрыва зависит от величины хранящиеся в ней эссенции.
При взрыве одни частицы могут закрывать собой другие частицы - сила воздействия взрыва зависит от размера сектора видимости частицы 
от центра взрыва.
 - `Soul` - У каждой игрока может быть только одна. Обладает свойствами `Mover` и `Regenerator`. В начале игры это единственная частица, которая есть у игроков, остальные частицы в мире нейтральные.
 - `Regenerator` - автоматически регенерирует хранимую в ней эссенцию, ее число автоматом увеличивается на определенный процент каждый тик. Но у `Soul` величина регенерации выше.
 - `Devourer` - позволяет поглощать эссенцию других частиц. Она переносится из второй частицы к первой.

У частиц есть четыре динамических параметра: `type`, `essence`, `position`, `velocity`, остальные свойства зависят от `type`.

## Команды
Для каждой частицы, которой управляет игрок, можно отдавать команды.
Некоторые команды целиком относятся только к одной частице, а некоторые еще принимают другую близкую частицу. 
Возможные команды:
 - `applyForce(targetParticle, force)` - приложить силу, силы по третьему закону Ньютона прикладываются вдоль прямой 
проходящей между центрами частиц, и одинакова для них обоих, но противоположная по направлению. Величина силы
ограничена значением `particleType.maxForce * particle.essence / particleType.maxEssenceCapacity`.
Сила применяется только в начале тика - значения скоростей частиц меняется на величину `0.5*force*tick`.
Если значение силы больше нуля, то частицы отталкиваются, если меньше, то притягиваются.
 - `thrust(acceleration)` - ускорение частицы, используется только для `Mover` частиц. 
Скорость частицы в начале тика меняется на величину `acceleration*tick`.
Значение ускорения ограничено по абсолютной величине значением `particleType.maxThrust * particle.essence / particleType.maxEssenceCapacity`.
 - `transferEssence(targetParticle, amount, targetType)` - передача эссенции от нашей частицы к другой частице.
Если вторая частица принадлежит нам, и ее тип совпадает с `targetType`, то величина её эссенции увеличивается.
Если вторая частица была нейтральной, то она превращается в тип `targetType`.
В других случаях величина эссенции второй частицы уменьшается.
Величина amount больше нуля и ограничена значением
`min(thisParticleType.maxEssenceOutcomePerSecond, targetParticleType.maxEssenceIncomePerSecond)*tick`.
У нейтральной частицы `maxEssenceIncomePerSecond` не ограничено.
Если передано эссенции больше, чем может уместить частица, то излишек уничтожается.
 - `devour(targetParticle, amount)` - поглощение эссенции второй частицы, она переходит к нашей частице.
Применяется только для частиц с типом `Devour`. 
Величина amount больше нуля и ограничена значением 
`min(thisParticleType.maxEssenceIncomePerSecond, targetParticleType.maxEssenceOutcomePerSecond)*tick`. 
Если принято эссенции больше, чем может уместить частица, то излишек уничтожается.
 - `explode` - взрыв, применимо только к `Explosive` частицам.
Радиус взрыва равен `explosionRadius = explosionRadiusPerEssence * particle.essence`.
Частицы в этом радиусе (расстояние между центрами нашей частицы и другой частицы), меняют скорость на величину
`explosionImpulsePerEssencePerRadian * particle.essence * sectorAngle * (1.0 - distance / explosionRadius)`, 
где `distance` это расстояние между центрами частиц, а `sectorAngle` это угол видимости размера другой частицы из центра
нашей частицы. Другие частицы находящиеся между нами и рассматриваемой другой частицей могут закрывать собой
её, и тем самым уменьшать значение `sectorAngle`.
Часть импульса передаваемого взрывом другим частицам так же возвращается и нашей частице с коэффициентом `explosionImpulseReturn`.

## Механика
В начале тика сначала применяются команды `applyForce` и `thrust`, пересчитываются скорости частиц.
Дальше применяются команды `transferEssence`, пересчитываются значения эссенции частиц.
Дальше команды `devour`, еще раз пересчитываются значения эссенции частиц.
Потом команды `explode`, а так же рассчитывается взрыв частиц, которые самостоятельно детонировали из-за высокого
изменения импульса в предыдущем тике. Пересчитываются скорости частиц. Сами взорвавшиеся частицы становятся нейтральными.

После чего проводится симуляция движения частиц и их столкновений.
Считается сумма квадратов значений изменения импульса для `applyForce` + `thrust` команд (одно число),
значений изменения импульса при каждом столкновении, и изменений импульса при каждом взрыве.
Если это число превысит значение квадрат `essenceLossMinImpulse`, то частица получает "урон" - для
`explosive` частиц происходит детонация, её взрыв будет рассчитан в следующем тике, а для других уровень эссенции
уменьшится на `(sqrt(sumOfImpulsesChangeSquared) - params.essenceLossMinImpulse) * essenceLossPerImpulse`.

Дальше все частицы игроков кроме `Soul` теряют эссенцию на величину `essenceDeclinePerSecond * tick`, и дальше
частицы `Soul` и `Regenerator` увеличивают эссенцию на `100*essenceRegenerationSpeedPerSecond * tick` процентов.

В конце, все частицы у которых значение эссенции упало до нуля становятся нейтральными.
